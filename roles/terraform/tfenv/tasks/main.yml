---

- name: Git checkout tfenv
  become: true
  git:
    repo: 'https://github.com/tfutils/tfenv'
    dest: $HOME/.local/lib/tfenv
    version: master
  register: result

- name: Install tfenv binary
  become: true
  file:
    src: $HOME/.local/lib/tfenv/bin/{{ item }}
    dest: $HOME/.local/bin/{{ item }}
    state: link
  loop:
    - terraform
    - tfenv
  when: result is success and not ansible_check_mode
  register: result

- name: Install and setup terraform
  become: true
  shell: 
    cmd: |
      tfenv install '{{ tf_version }}'
      tfenv use '{{ tf_version }}'
    chdir: ~
    creates: "$HOME/.local/lib/tfenv/versions/'{{ tf_version }}'/terraform"
  when: not ansible_check_mode

# Autocomplete for bash and zsh
# grep -q ".local/lib/tfenv/versions/'{{ tf_version }}'/terraform" ~/.bashrc ~/.zshrc && true || terraform -install-autocomplete
